@model List<CIResearch.Models.QLKH>

@{
    ViewData["Title"] = "Dữ liệu thô - CI Research";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">

    <style>
        /* Reset và Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-image: url('/IMG(4UU)/STOREAUDIT.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        /* Header Navigation */
        .top-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        /* Navigation Filter Styles */
        .filter-toggle-btn {
            border-color: rgba(255, 255, 255, 0.5) !important;
            color: white !important;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        .filter-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: white !important;
            color: white !important;
            transform: translateY(-1px);
        }

        .filter-toggle-btn:focus {
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25) !important;
            color: white !important;
        }

        #navigationFilterSection {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideDown 0.3s ease-out;
        }

        @@keyframes slideDown
        {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .nav-filter-container {
                padding: 1rem;
                border-radius: 10px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .nav-filter-header {
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            }

            .nav-filter-body .custom-multi-select {
                width: 100%;
                margin: 0;
            }

            .nav-filter-body .select-box {
                background-color: rgba(255, 255, 255, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 6px;
                color: #333;
                font-size: 0.875rem;
                padding: 0.5rem;
            }

            .nav-filter-body .select-box:hover {
                background-color: white;
                border-color: #007bff;
            }

            .nav-filter-body .dropdown-options {
                background-color: white;
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 6px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                z-index: 10000;
            }

            .nav-filter-body .btn {
                font-size: 0.875rem;
                padding: 0.4rem 0.8rem;
                border-radius: 6px;
                transition: all 0.2s ease;
            }

            .nav-filter-body .btn-outline-light {
                border-color: rgba(255, 255, 255, 0.5);
                color: white;
            }

            .nav-filter-body .btn-outline-light:hover {
                background-color: white;
                color: #333;
                border-color: white;
            }

            .nav-filter-body .btn-light {
                background-color: white;
                color: #333;
                border-color: white;
            }

            .nav-filter-body .btn-light:hover {
                background-color: #f8f9fa;
                transform: translateY(-1px);
            }

            .nav-filter-body .btn-success {
                background-color: #28a745;
                border-color: #28a745;
            }

            .nav-filter-body .btn-success:hover {
                background-color: #218838;
                transform: translateY(-1px);
            }

            .nav-filter-body .btn-info {
                background-color: #17a2b8;
                border-color: #17a2b8;
            }

            .nav-filter-body .btn-info:hover {
                background-color: #138496;
                transform: translateY(-1px);
            }

            .nav-filter-body .btn-warning {
                background-color: #ffc107;
                border-color: #ffc107;
                color: #333;
            }

            .nav-filter-body .btn-warning:hover {
                background-color: #e0a800;
                transform: translateY(-1px);
            }

                    /* Chevron animation */
        #filterChevron {
            transition: transform 0.3s ease;
        }

        /* Export Options UI Styles */
        #exportOptionsUI {
            animation: slideDown 0.3s ease-out;
        }

        .export-option {
            transition: all 0.3s ease;
        }

        .export-option .form-control {
            border-radius: 6px;
            border: 1px solid #ced4da;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .export-option .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .export-option .btn-success {
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .export-option .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .export-option .form-label {
            color: #495057;
            font-size: 0.9rem;
        }

        #exportOptionsUI .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        #exportOptionsUI .card-header {
            border-radius: 10px 10px 0 0;
            font-weight: 600;
        }

            #filterChevron.rotated {
                transform: rotate(180deg);
            }

            /* Mobile responsiveness for navigation filter */
                        @@media (max-width: 768px) {
                    .nav-filter-body .row .col-lg-2 {
                        margin-bottom: 0.5rem;
                    }

                    .filter-toggle-btn {
                        font-size: 0.75rem;
                        padding: 0.25rem 0.5rem;
                    }

                    .filter-toggle-btn span {
                        display: none;
                    }

                    .nav-filter-container {
                        padding: 0.75rem;
                    }

                    .nav-filter-body .btn {
                        font-size: 0.75rem;
                        padding: 0.3rem 0.6rem;
                    }
                }

                                @@media(max - width: 576px) {
                        .top-nav {
                            padding: 0.75rem 0;
                        }

                        .nav-brand {
                            font-size: 1.2rem;
                        }

                        .user-info {
                            font-size: 0.8rem;
                        }
                    }

                    .nav-brand {
                        color: white;
                        font-size: 1.5rem;
                        font-weight: 700;
                        text-decoration: none;
                        display: flex;
                        align-items: center;
                    }

                    .nav-brand:hover {
                        color: #f8f9fa;
                        text-decoration: none;
                    }

                    .nav-brand i {
                        margin-right: 0.5rem;
                    }

                    .user-info {
                        color: white;
                        font-weight: 500;
                    }

                    /* Filter styles */
                    .custom-multi-select {
                        position: relative;
                        width: 100%;
                        margin: 0 auto;
                    }

                    .select-box {
                        padding: 10px;
                        border: 1px solid #ccc;
                        cursor: pointer;
                        background-color: #fff;
                        position: relative;
                        border-radius: 8px;
                    }

                    .selected-options {
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        width: 100%;
                    }

                    .arrow {
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%) rotate(45deg);
                        border: solid #666;
                        border-width: 0 2px 2px 0;
                        padding: 3px;
                    }

                    .dropdown-options {
                        display: none;
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background-color: #fff;
                        border: 1px solid #ccc;
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 9999;
                        border-radius: 8px;
                        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
                    }

                    .custom-multi-select.active {
                        z-index: 10000;
                    }

                    .dropdown-options label {
                        display: block;
                        padding: 8px;
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }

                    .dropdown-options label:hover {
                        background-color: #f0f0f0;
                    }

                    .search-box {
                        width: 100%;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-bottom: 2px solid #007bff;
                        font-size: 14px;
                        outline: none;
                        border-radius: 8px 8px 0 0;
                    }

                    .search-box:focus {
                        border-color: #007bff;
                        box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
                    }

                    /* Container chính */
                    .main-container {
                        width: 100%;
                        min-height: calc(100vh - 80px);
                        padding: 0;
                        margin: 0;
                    }

                    /* Content wrapper */
                    .content-wrapper {
                        width: 100%;
                        padding: 2rem;
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(10px);
                        min-height: calc(100vh - 80px);
                    }

                    /* DataTable custom styles */
                    .table-container {
                        background: white;
                        border-radius: 15px;
                        padding: 20px;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        margin-top: 20px;
                    }

                    .dataTables_wrapper .dataTables_length,
                    .dataTables_wrapper .dataTables_filter,
                    .dataTables_wrapper .dataTables_info,
                    .dataTables_wrapper .dataTables_paginate {
                        margin-bottom: 10px;
                    }

                    .dataTables_wrapper .dataTables_paginate .paginate_button {
                        border-radius: 6px;
                        margin: 0 2px;
                    }

                    .table-striped>tbody>tr:nth-child(odd)>td {
                        background-color: rgba(0, 0, 0, 0.02);
                    }

                    /* Limit options styles */
                    .limit-options {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                        margin-bottom: 20px;
                        border: 1px solid #e5e7eb;
                    }

                    .limit-option {
                        display: flex;
                        align-items: center;
                        margin-bottom: 10px;
                        padding: 8px;
                        border-radius: 6px;
                        transition: background-color 0.2s;
                    }

                    .limit-option:hover {
                        background-color: #f8f9fa;
                    }

                    .limit-option input[type="radio"] {
                        margin-right: 10px;
                    }

                    .custom-range-inputs {
                        display: none;
                        margin-top: 10px;
                        padding: 10px;
                        background-color: #f8f9fa;
                        border-radius: 6px;
                        border: 1px solid #dee2e6;
                    }

                    .custom-range-inputs.show {
                        display: block;
                    }

                    .form-control-sm {
                        font-size: 0.875rem;
                    }

                    /* Error message styles */
                    .alert {
                        border-radius: 8px;
                        border: none;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    }

                    .alert-danger {
                        background: linear-gradient(45deg, #dc3545, #c82333);
                        color: white;
                    }

                    .alert-success {
                        background: linear-gradient(45deg, #28a745, #218838);
                        color: white;
                    }

                    .alert-info {
                        background: linear-gradient(45deg, #17a2b8, #138496);
                        color: white;
                    }

                    /* Button styles */
                    .btn {
                        border-radius: 8px;
                        transition: all 0.3s ease;
                        font-weight: 500;
                    }

                    .btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                    }

                    /* Statistics section */
                    .statistics-section {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    }

                    .stat-item {
                        text-align: center;
                        padding: 10px;
                    }

                    .stat-number {
                        font-size: 2rem;
                        font-weight: 700;
                        margin-bottom: 5px;
                    }

                    .stat-label {
                        font-size: 0.9rem;
                        opacity: 0.9;
                    }
                </style>
            </head>

            <body>
                <!-- Top Navigation -->
                <nav class="top-nav">
                    <div class="container-fluid px-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <a href="@Url.Action("Index", "DN")" class="nav-brand">
                                    <i class="fas fa-table"></i>
                                    ViewRawData - Dữ liệu thô
                                </a>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="d-flex align-items-center justify-content-end gap-3">
                                    <div class="user-info">
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
                                    </div>

                                    <!-- Filter Toggle Button -->
                                    <button class="btn btn-outline-light btn-sm filter-toggle-btn"
                                        onclick="toggleNavigationFilter()" id="filterToggleBtn">
                                        <i class="fas fa-filter me-1" id="filterToggleIcon"></i>
                                        <span id="filterToggleText">Bộ lọc</span>
                                        <i class="fas fa-chevron-down ms-1" id="filterChevron"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Collapsible Filter Section -->
                        <div class="row mt-3" id="navigationFilterSection" style="display: none;">
                            <div class="col-12">
                                <div class="nav-filter-container">
                                    <div class="nav-filter-header">
                                        <h6 class="mb-0 text-white">
                                            <i class="fas fa-filter me-2"></i>
                                            Bộ lọc dữ liệu doanh nghiệp
                                        </h6>
                                    </div>
                                    <div class="nav-filter-body">
                                        <form method="get" action="@Url.Action("ViewRawData", "DN")" class="filter-form">
                                            <div class="row g-2">
                                                <!-- Năm Multi-select -->
                                                <div class="col-lg-2 col-md-4 col-sm-6">
                                                    <div class="custom-multi-select" id="yearFilter">
                                                        <div class="select-box" onclick="toggleDropdown(this)">
                                                            <span class="selected-options" data-placeholder="Năm">Năm</span>
                                                            <i class="arrow"></i>
                                                        </div>
                                                        <div class="dropdown-options">
                                                            <input type="text" class="search-box" placeholder="Tìm kiếm năm"
                                                                oninput="filterOptions(this)">
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Tỉnh/Thành phố Multi-select -->
                                                <div class="col-lg-2 col-md-4 col-sm-6">
                                                    <div class="custom-multi-select" id="provinceFilter">
                                                        <div class="select-box" onclick="toggleDropdown(this)">
                                                            <span class="selected-options"
                                                                data-placeholder="Tỉnh/Thành phố">Tỉnh/Thành phố</span>
                                                            <i class="arrow"></i>
                                                        </div>
                                                        <div class="dropdown-options">
                                                            <input type="text" class="search-box" placeholder="Tìm kiếm tỉnh thành"
                                                                oninput="filterOptions(this)">
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Loại hình kinh tế Multi-select -->
                                                <div class="col-lg-2 col-md-4 col-sm-6">
                                                    <div class="custom-multi-select" id="businessTypeFilter">
                                                        <div class="select-box" onclick="toggleDropdown(this)">
                                                            <span class="selected-options" data-placeholder="Loại hình kinh tế">Loại
                                                                hình kinh tế</span>
                                                            <i class="arrow"></i>
                                                        </div>
                                                        <div class="dropdown-options">
                                                            <input type="text" class="search-box" placeholder="Tìm kiếm loại hình"
                                                                oninput="filterOptions(this)">
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Vùng kinh tế Multi-select -->
                                                <div class="col-lg-2 col-md-4 col-sm-6">
                                                    <div class="custom-multi-select" id="economicZoneFilter">
                                                        <div class="select-box" onclick="toggleDropdown(this)">
                                                            <span class="selected-options" data-placeholder="Vùng kinh tế">Vùng kinh
                                                                tế</span>
                                                            <i class="arrow"></i>
                                                        </div>
                                                        <div class="dropdown-options">
                                                            <input type="text" class="search-box"
                                                                placeholder="Tìm kiếm vùng kinh tế" oninput="filterOptions(this)">
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Bộ lọc xuất dữ liệu - Custom dropdown -->
                                                <div class="col-lg-2 col-md-4 col-sm-6">
                                                    <div class="custom-multi-select" id="exportTypeFilter">
                                                        <div class="select-box" onclick="toggleDropdown(this)">
                                                            <span class="selected-options" data-placeholder="Kiểu xuất">Kiểu xuất</span>
                                                            <i class="arrow"></i>
                                                        </div>
                                                        <div class="dropdown-options">
                                                            <!-- No search box for export options -->
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Quick Actions -->
                                                <div class="col-lg-2 col-md-4 col-sm-6">
                                                    <div class="d-flex gap-1">
                                                        <button type="button" class="btn btn-outline-light btn-sm flex-fill"
                                                            onclick="clearAllFilters()" title="Xóa bộ lọc">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-light btn-sm flex-fill"
                                                            onclick="debugFilters()" title="Debug filters">
                                                            <i class="fas fa-bug"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-light btn-sm flex-fill"
                                                            onclick="testExportExcel()" title="Test Export Excel">
                                                            <i class="fas fa-file-excel"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Action Buttons Row -->
                                            <div class="row mt-2">
                                                <div class="col-12">
                                                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                                                        <button type="submit" class="btn btn-light btn-sm">
                                                            <i class="fas fa-search me-1"></i>
                                                            Áp dụng bộ lọc
                                                        </button>
                                                        <a href="@Url.Action("Index", "DN")" class="btn btn-success btn-sm">
                                                            <i class="fas fa-chart-bar me-1"></i>
                                                            Dashboard
                                                        </a>
                                                        <button type="button" class="btn btn-info btn-sm" onclick="exportToExcel(this)">
                                                            <i class="fas fa-file-excel me-1"></i>
                                                            Export Excel
                                                        </button>
                                                        <button type="button" class="btn btn-warning btn-sm"
                                                            onclick="showFilterGuide()">
                                                            <i class="fas fa-question-circle me-1"></i>
                                                            Hướng dẫn
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Export Options UI -->
                                            <div id="exportOptionsUI" class="mt-3" style="display: none;">
                                                <div class="card border-primary">
                                                    <div class="card-header bg-primary text-white">
                                                        <i class="fas fa-cog me-2"></i>
                                                        <span id="exportOptionsTitle">Cấu hình xuất dữ liệu</span>
                                                    </div>
                                                    <div class="card-body">
                                                        <!-- First/Last/Random Options -->
                                                        <div id="countOptions" class="export-option" style="display: none;">
                                                            <div class="row align-items-center">
                                                                <div class="col-md-4">
                                                                    <label class="form-label fw-bold">
                                                                        <i class="fas fa-sort-numeric-up me-1"></i>
                                                                        Số lượng dòng:
                                                                    </label>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="exportCountField" 
                                                                           placeholder="Nhập số lượng (VD: 1000)"
                                                                           min="1" 
                                                                           max="10000">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-success btn-sm" onclick="applyExportCount()">
                                                                        <i class="fas fa-check"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Range Options -->
                                                        <div id="rangeOptions" class="export-option" style="display: none;">
                                                            <div class="row align-items-center">
                                                                <div class="col-md-3">
                                                                    <label class="form-label fw-bold">
                                                                        <i class="fas fa-arrows-alt-h me-1"></i>
                                                                        Khoảng STT:
                                                                    </label>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="rangeStartField" 
                                                                           placeholder="Từ STT"
                                                                           min="1">
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="rangeEndField" 
                                                                           placeholder="Đến STT"
                                                                           min="1">
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <button type="button" class="btn btn-success btn-sm" onclick="applyRangeInput()">
                                                                        <i class="fas fa-check"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Alternate Options -->
                                                        <div id="alternateOptions" class="export-option" style="display: none;">
                                                            <div class="row align-items-center">
                                                                <div class="col-md-2">
                                                                    <label class="form-label fw-bold">
                                                                        <i class="fas fa-random me-1"></i>
                                                                        Khoảng:
                                                                    </label>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="alternateStartField" 
                                                                           placeholder="Từ"
                                                                           min="1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="alternateEndField" 
                                                                           placeholder="Đến"
                                                                           min="1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label class="form-label fw-bold">
                                                                        <i class="fas fa-step-forward me-1"></i>
                                                                        Bước nhảy:
                                                                    </label>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <input type="number" 
                                                                           class="form-control" 
                                                                           id="stepSizeField" 
                                                                           placeholder="N"
                                                                           min="1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-success btn-sm" onclick="applyAlternateInput()">
                                                                        <i class="fas fa-check"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Hidden inputs for export options -->
                                            <input type="hidden" name="exportType" id="exportTypeInput"
                                                value="@ViewBag.CurrentExportType">
                                            <input type="hidden" name="exportCount" id="exportCountInput"
                                                value="@ViewBag.CurrentExportCount">
                                            <input type="hidden" name="rangeStart" id="rangeStartInput"
                                                value="@ViewBag.CurrentRangeStart">
                                            <input type="hidden" name="rangeEnd" id="rangeEndInput"
                                                value="@ViewBag.CurrentRangeEnd">
                                            <input type="hidden" name="stepSize" id="stepSizeInput"
                                                value="@ViewBag.CurrentStepSize">
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- Main Container -->
                <div class="main-container">
                    <div class="content-wrapper">

                        <!-- Page Header -->
                        <div class="statistics-section">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="stat-item">
                                        <div class="stat-number">@String.Format("{0:N0}", ViewBag.TotalRecords ?? 0)</div>
                                        <div class="stat-label">Tổng records</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-item">
                                        <div class="stat-number">@String.Format("{0:N0}", ViewBag.FilteredRecords ?? 0)</div>
                                        <div class="stat-label">Sau lọc</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-item">
                                        <div class="stat-number">@String.Format("{0:N0}", ViewBag.DisplayedRecords ?? 0)</div>
                                        <div class="stat-label">Hiển thị</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-item">
                                        <div class="stat-number">
                                            @{
                                                                                                var currentExportType = ViewBag.CurrentExportType?.ToString() ?? "first";
                                                var exportDisplayText = currentExportType switch
                                                {
                                                        "first" => "Đầu",
                                                        "last" => "Cuối",
                                                        "random" => "Random",
                                                        "range" => "Khoảng",
                                                        "alternate" => "Xen kẻ",
                                                        _ => "Đầu"
                                                };
                                                                                        }
                                            @exportDisplayText
                                        </div>
                                        <div class="stat-label">Kiểu xuất</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error Message -->
                        @if (!string.IsNullOrEmpty(ViewBag.Error?.ToString()))
                        {
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    @ViewBag.Error
                                </div>
                        }

                        <!-- Success Message -->
                        @if (TempData["SuccessMessage"] != null)
                        {
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    @TempData["SuccessMessage"]
                                </div>
                        }

                        <!-- Data Table -->
                        <div class="table-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>
                                    Bảng dữ liệu doanh nghiệp
                                </h5>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshTable()">
                                        <i class="fas fa-sync-alt me-1"></i>
                                        Làm mới
                                    </button>
                                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="exportToExcel(this)" title="Tải về file Excel với dữ liệu hiện tại">
                            <i class="fas fa-file-excel me-1"></i>
                            Export Excel
                        </button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table id="dataTable" class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>STT</th>
                                            <th>Năm</th>
                                            <th>Mã số thuế</th>
                                            <th>Tên DN</th>
                                            <th>Loại hình KT</th>
                                            <th>Mã tỉnh</th>
                                            <th>Mã huyện</th>
                                            <th>Mã xã</th>
                                            <th>Địa chỉ</th>
                                            <th>Điện thoại</th>
                                            <th>Email</th>
                                            <th>Vùng KT</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model)
                                        {
                                                <tr>
                                                    <td>@item.STT</td>
                                                    <td>@item.Nam</td>
                                                    <td>@(item.Masothue ?? "N/A")</td>
                                                    <td>@(item.TenDN ?? "N/A")</td>
                                                    <td>@(item.Loaihinhkte ?? "N/A")</td>
                                                    <td>@(item.MaTinh_Dieutra ?? "N/A")</td>
                                                    <td>@(item.MaHuyen_Dieutra ?? "N/A")</td>
                                                    <td>@(item.MaXa_Dieutra ?? "N/A")</td>
                                                    <td>@(item.Diachi ?? "N/A")</td>
                                                    <td>@(item.Dienthoai ?? "N/A")</td>
                                                    <td>@(item.Email ?? "N/A")</td>
                                                    <td>@(item.Region ?? "N/A")</td>
                                                </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Bootstrap JS Bundle -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                <!-- jQuery -->
                <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
                <!-- DataTables JS -->
                <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
                <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
                <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
                <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

                <!-- Navigation Filter JavaScript Functions -->
                <script>
                    // Navigation Filter Toggle Function
                    function toggleNavigationFilter() {
                        const filterSection = document.getElementById('navigationFilterSection');
                        const filterChevron = document.getElementById('filterChevron');
                        const toggleText = document.getElementById('filterToggleText');
                        const toggleIcon = document.getElementById('filterToggleIcon');

                        if (filterSection.style.display === 'none' || !filterSection.style.display) {
                            // Show filter
                            filterSection.style.display = 'block';
                            filterChevron.classList.add('rotated');
                            toggleText.textContent = 'Thu gọn';
                            toggleIcon.className = 'fas fa-chevron-up me-1';

                            // Save state to localStorage
                            localStorage.setItem('navigationFilterExpanded', 'true');

                            console.log('📖 Navigation filter expanded');
                        } else {
                            // Hide filter
                            filterSection.style.display = 'none';
                            filterChevron.classList.remove('rotated');
                            toggleText.textContent = 'Bộ lọc';
                            toggleIcon.className = 'fas fa-filter me-1';

                            // Save state to localStorage
                            localStorage.setItem('navigationFilterExpanded', 'false');

                            // Close any open dropdowns when hiding
                            document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                                dropdown.style.display = 'none';
                            });

                            console.log('📝 Navigation filter collapsed');
                        }
                    }

                    // Toggle dropdown visibility
                    function toggleDropdown(element) {
                        const dropdown = element.nextElementSibling;
                        const isVisible = dropdown.style.display === 'block';

                        // Close all other dropdowns first
                        document.querySelectorAll('.dropdown-options').forEach(d => {
                            if (d !== dropdown) d.style.display = 'none';
                        });

                        // Toggle current dropdown
                        dropdown.style.display = isVisible ? 'none' : 'block';

                        // Update selected display
                        updateSelectedDisplay(element);
                    }

                    // Filter options based on search input
                    function filterOptions(searchInput) {
                        const filter = searchInput.value.toLowerCase();
                        const dropdown = searchInput.parentElement;
                        const labels = dropdown.querySelectorAll('label');

                        labels.forEach(label => {
                            const text = label.textContent.toLowerCase();
                            if (text.includes(filter)) {
                                label.style.display = 'block';
                            } else {
                                label.style.display = 'none';
                            }
                        });
                    }

                    // Update selected options display
                    function updateSelectedDisplay(selectBox) {
                        const dropdown = selectBox.nextElementSibling;
                        const selectedSpan = selectBox.querySelector('.selected-options');
                        const checkedInputs = dropdown.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked');
                        const placeholder = selectedSpan.getAttribute('data-placeholder');

                        if (checkedInputs.length === 0) {
                            selectedSpan.textContent = placeholder;
                        } else if (checkedInputs.length === 1) {
                            selectedSpan.textContent = checkedInputs[0].nextSibling.textContent.trim();
                        } else {
                            selectedSpan.textContent = `${checkedInputs.length} mục đã chọn`;
                        }
                    }

                    // Clear all filters
                    function clearAllFilters() {
                        // Uncheck all checkboxes and radio buttons
                        document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
                            input.checked = false;
                        });

                        // Reset all select displays
                        document.querySelectorAll('.select-box').forEach(selectBox => {
                            updateSelectedDisplay(selectBox);
                        });

                        // Clear hidden inputs
                        document.querySelectorAll('input[type="hidden"]').forEach(input => {
                            input.value = '';
                        });

                        console.log('🧹 All filters cleared');
                    }

                    // Close dropdowns when clicking outside
                    document.addEventListener('click', function (event) {
                        if (!event.target.closest('.custom-multi-select')) {
                            document.querySelectorAll('.dropdown-options').forEach(dropdown => {
                                dropdown.style.display = 'none';
                            });
                        }
                    });

                    // Initialize filter UI and load dynamic data
                    document.addEventListener('DOMContentLoaded', function () {
                        console.log('🔧 Initializing ViewRawData filter UI...');

                        // Check saved state
                        const isExpanded = localStorage.getItem('navigationFilterExpanded') === 'true';

                        if (isExpanded) {
                            // Expand filter if it was previously expanded
                            setTimeout(() => {
                                toggleNavigationFilter();
                            }, 100);
                        }

                        // Load dynamic filter options from database
                        loadDynamicFilterOptions();

                        // Initialize DataTable
                        initializeDataTable();

                        document.querySelectorAll('.select-box').forEach(selectBox => {
                            updateSelectedDisplay(selectBox);
                        });
                    });

                    // Load dynamic filter options from database
                    function loadDynamicFilterOptions() {
                        console.log('📡 Loading dynamic filter options from database...');

                        fetch('/DN/GetFilterOptions')
                            .then(response => {
                                console.log('📡 Filter options response status:', response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log('📊 Filter options data:', data);

                                if (data.success) {
                                    console.log('✅ Filter options loaded successfully');

                                    // Populate each filter dropdown
                                    populateFilterDropdown('yearFilter', data.filters.years, 'Nam', @Html.Raw(Json.Serialize(ViewBag.CurrentNam ?? new List<string>())));
                                    populateFilterDropdown('businessTypeFilter', data.filters.businessTypes, 'Loaihinhkte', @Html.Raw(Json.Serialize(ViewBag.CurrentLoaihinhkte ?? new List<string>())));
                                    populateFilterDropdown('provinceFilter', data.filters.provinces, 'MaTinh_Dieutra', @Html.Raw(Json.Serialize(ViewBag.CurrentMaTinh ?? new List<string>())));
                                    populateFilterDropdown('economicZoneFilter', data.filters.economicZones, 'Vungkinhte', @Html.Raw(Json.Serialize(ViewBag.CurrentVungkinhte ?? new List<string>())));

                                    // Populate export type filter (different structure)
                                    populateExportTypeFilter();

                                    // Initialize event listeners after options are loaded
                                    initializeFilterEventListeners();

                                    // Update display for all filters
                                    document.querySelectorAll('.select-box').forEach(selectBox => {
                                        updateSelectedDisplay(selectBox);
                                    });

                                    console.log('✅ All filters populated successfully');
                                } else {
                                    console.error('❌ Failed to load filter options:', data.message);
                                    console.log('⚠️ Using fallback options');
                                    loadFallbackFilterOptions();
                                }
                            })
                            .catch(error => {
                                console.error('❌ Error loading filter options:', error);
                                console.log('⚠️ Using fallback options');
                                loadFallbackFilterOptions();
                            });
                    }

                    // Populate individual filter dropdown
                    function populateFilterDropdown(filterId, options, fieldName, currentValues) {
                        const filterElement = document.getElementById(filterId);
                        if (!filterElement) {
                            console.warn(`⚠️ Filter element ${filterId} not found`);
                            return;
                        }

                        const dropdown = filterElement.querySelector('.dropdown-options');
                        const searchBox = dropdown.querySelector('.search-box');

                        // Clear existing options (except search box)
                        const existingLabels = dropdown.querySelectorAll('label');
                        existingLabels.forEach(label => label.remove());

                        // Add new options
                        let optionsHTML = '';
                        options.forEach(option => {
                            const isChecked = currentValues && currentValues.includes(option) ? 'checked' : '';
                            optionsHTML += `
                                            <label>
                                                <input type="checkbox" name="${fieldName}" value="${option}" ${isChecked} /> ${option}
                                            </label>
                                        `;
                        });

                        // Insert after search box
                        if (searchBox) {
                            searchBox.insertAdjacentHTML('afterend', optionsHTML);
                        } else {
                            dropdown.innerHTML = optionsHTML;
                        }

                        console.log(`✅ Populated ${filterId} with ${options.length} options`);
                    }

                    // Populate export type filter (special handling)
                    function populateExportTypeFilter() {
                        const filterElement = document.getElementById('exportTypeFilter');
                        if (!filterElement) {
                            console.warn('⚠️ Export type filter element not found');
                            return;
                        }

                        const dropdown = filterElement.querySelector('.dropdown-options');
                        const currentExportType = '@ViewBag.CurrentExportType' || 'first';

                        const exportOptions = [
                            { value: 'first', text: 'Xuất Các Dòng Đầu' },
                            { value: 'last', text: 'Xuất Các Dòng Cuối' },
                            { value: 'random', text: 'Xuất Random' },
                            { value: 'range', text: 'Chọn Khoảng từ 2 số đầu cuối X và Y' },
                            { value: 'alternate', text: 'Xuất Xen kẻ' }
                        ];

                        let optionsHTML = '';
                        exportOptions.forEach(option => {
                            const isChecked = currentExportType === option.value ? 'checked' : '';
                            optionsHTML += `
                                            <label onclick="handleExportTypeChange('${option.value}')">
                                                <input type="radio" name="exportTypeRadio" value="${option.value}" ${isChecked} /> ${option.text}
                                            </label>
                                        `;
                        });

                        dropdown.innerHTML = optionsHTML;
                        console.log('✅ Populated export type filter');
                    }

                    // Handle export type change
                    function handleExportTypeChange(exportType) {
                        console.log('🔄 Export type changed to:', exportType);

                        // Update hidden input
                        document.getElementById('exportTypeInput').value = exportType;

                        // Update display
                        const exportBox = document.getElementById('exportTypeFilter').querySelector('.select-box');
                        updateSelectedDisplay(exportBox);

                        // Show/hide export options UI based on type
                        showExportOptions(exportType);
                    }

                    // Show export options UI based on type
                    function showExportOptions(exportType) {
                        const exportOptionsUI = document.getElementById('exportOptionsUI');
                        const exportOptionsTitle = document.getElementById('exportOptionsTitle');
                        
                        // Hide all options first
                        document.querySelectorAll('.export-option').forEach(option => {
                            option.style.display = 'none';
                        });

                        // Show UI and specific options based on type
                        switch (exportType) {
                            case 'first':
                            case 'last':
                            case 'random':
                                exportOptionsUI.style.display = 'block';
                                document.getElementById('countOptions').style.display = 'block';
                                const typeText = exportType === 'first' ? 'Đầu' : exportType === 'last' ? 'Cuối' : 'Random';
                                exportOptionsTitle.textContent = `Cấu hình xuất ${typeText} dòng`;
                                
                                // Set default value
                                document.getElementById('exportCountField').value = '1000';
                                break;
                                
                            case 'range':
                                exportOptionsUI.style.display = 'block';
                                document.getElementById('rangeOptions').style.display = 'block';
                                exportOptionsTitle.textContent = 'Cấu hình xuất theo khoảng STT';
                                
                                // Set default values
                                document.getElementById('rangeStartField').value = '1';
                                document.getElementById('rangeEndField').value = '1000';
                                break;
                                
                            case 'alternate':
                                exportOptionsUI.style.display = 'block';
                                document.getElementById('alternateOptions').style.display = 'block';
                                exportOptionsTitle.textContent = 'Cấu hình xuất xen kẻ';
                                
                                // Set default values
                                document.getElementById('alternateStartField').value = '1';
                                document.getElementById('alternateEndField').value = '1000';
                                document.getElementById('stepSizeField').value = '3';
                                break;
                                
                            default:
                                exportOptionsUI.style.display = 'none';
                                break;
                        }
                    }

                    // Apply export count (for first, last, random)
                    function applyExportCount() {
                        const count = document.getElementById('exportCountField').value;
                        if (count && !isNaN(count) && count > 0) {
                            document.getElementById('exportCountInput').value = count;
                            showSuccessMessage(`✅ Đã cấu hình xuất ${count} dòng`);
                            console.log('✅ Export count set:', count);
                        } else {
                            showErrorMessage('❌ Vui lòng nhập số lượng hợp lệ');
                        }
                    }

                    // Apply range input (for range option)
                    function applyRangeInput() {
                        const start = document.getElementById('rangeStartField').value;
                        const end = document.getElementById('rangeEndField').value;
                        
                        if (start && end && !isNaN(start) && !isNaN(end) && start > 0 && end > 0) {
                            if (parseInt(start) <= parseInt(end)) {
                                document.getElementById('rangeStartInput').value = start;
                                document.getElementById('rangeEndInput').value = end;
                                showSuccessMessage(`✅ Đã cấu hình khoảng STT từ ${start} đến ${end}`);
                                console.log('✅ Range set:', start, '-', end);
                            } else {
                                showErrorMessage('❌ STT bắt đầu phải nhỏ hơn hoặc bằng STT kết thúc');
                            }
                        } else {
                            showErrorMessage('❌ Vui lòng nhập khoảng STT hợp lệ');
                        }
                    }

                    // Apply alternate input (for alternate option)
                    function applyAlternateInput() {
                        const start = document.getElementById('alternateStartField').value;
                        const end = document.getElementById('alternateEndField').value;
                        const step = document.getElementById('stepSizeField').value;
                        
                        if (start && end && step && !isNaN(start) && !isNaN(end) && !isNaN(step) && 
                            start > 0 && end > 0 && step > 0) {
                            if (parseInt(start) <= parseInt(end)) {
                                document.getElementById('rangeStartInput').value = start;
                                document.getElementById('rangeEndInput').value = end;
                                document.getElementById('stepSizeInput').value = step;
                                showSuccessMessage(`✅ Đã cấu hình xuất xen kẻ từ ${start} đến ${end} với bước nhảy ${step}`);
                                console.log('✅ Alternate set:', start, '-', end, 'step:', step);
                            } else {
                                showErrorMessage('❌ STT bắt đầu phải nhỏ hơn hoặc bằng STT kết thúc');
                            }
                        } else {
                            showErrorMessage('❌ Vui lòng nhập thông tin hợp lệ');
                        }
                    }

                    // Show success message
                    function showSuccessMessage(message) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
                        alertDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;

                        const exportOptionsUI = document.getElementById('exportOptionsUI');
                        exportOptionsUI.parentNode.insertBefore(alertDiv, exportOptionsUI.nextSibling);

                        // Auto remove after 3 seconds
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 3000);
                    }

                    // Show error message
                    function showErrorMessage(message) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-2';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;

                        const exportOptionsUI = document.getElementById('exportOptionsUI');
                        exportOptionsUI.parentNode.insertBefore(alertDiv, exportOptionsUI.nextSibling);

                        // Auto remove after 5 seconds
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 5000);
                    }

                    // Initialize event listeners after filters are populated
                    function initializeFilterEventListeners() {
                        // Add change event listeners to all checkboxes and radio buttons
                        document.querySelectorAll('.dropdown-options input[type="checkbox"], .dropdown-options input[type="radio"]').forEach(input => {
                            input.addEventListener('change', function () {
                                const selectBox = this.closest('.custom-multi-select').querySelector('.select-box');
                                updateSelectedDisplay(selectBox);
                            });
                        });

                        console.log('✅ Filter event listeners initialized');
                    }

                    // Fallback options if API fails
                    function loadFallbackFilterOptions() {
                        const fallbackData = {
                            years: ['2018', '2019', '2020', '2021', '2022', '2023', '2024'],
                            businessTypes: ['Công ty TNHH', 'Công ty cổ phần', 'Doanh nghiệp tư nhân', 'Doanh nghiệp nhà nước'],
                            provinces: ['Hà Nội', 'Hồ Chí Minh', 'Đà Nẵng', 'Hải Phòng', 'Cần Thơ'],
                            economicZones: ['Đông Nam Bộ', 'Đồng bằng Sông Hồng', 'Duyên hải Nam Trung Bộ']
                        };

                        populateFilterDropdown('yearFilter', fallbackData.years, 'Nam', []);
                        populateFilterDropdown('businessTypeFilter', fallbackData.businessTypes, 'Loaihinhkte', []);
                        populateFilterDropdown('provinceFilter', fallbackData.provinces, 'MaTinh_Dieutra', []);
                        populateFilterDropdown('economicZoneFilter', fallbackData.economicZones, 'Vungkinhte', []);
                        populateExportTypeFilter();

                        initializeFilterEventListeners();
                        console.log('✅ Fallback options loaded');
                    }

                    // Initialize DataTable
                    function initializeDataTable() {
                        $('#dataTable').DataTable({
                            responsive: true,
                            pageLength: 25,
                            order: [[0, 'asc']],
                            language: {
                                "sProcessing": "Đang xử lý...",
                                "sLengthMenu": "Hiển thị _MENU_ mục",
                                "sZeroRecords": "Không tìm thấy dòng nào phù hợp",
                                "sInfo": "Hiển thị _START_ đến _END_ trong tổng số _TOTAL_ mục",
                                "sInfoEmpty": "Hiển thị 0 đến 0 trong tổng số 0 mục",
                                "sInfoFiltered": "(được lọc từ _MAX_ mục)",
                                "sSearch": "Tìm kiếm:",
                                "oPaginate": {
                                    "sFirst": "Đầu",
                                    "sPrevious": "Trước",
                                    "sNext": "Tiếp",
                                    "sLast": "Cuối"
                                }
                            },
                            columnDefs: [
                                { targets: [0], width: "5%" },
                                { targets: [1], width: "7%" },
                                { targets: [2], width: "10%" },
                                { targets: [3], width: "20%" },
                                { targets: [4], width: "12%" },
                                { targets: [5, 6, 7], width: "7%" },
                                { targets: [8], width: "15%" },
                                { targets: [9, 10], width: "10%" },
                                { targets: [11], width: "7%" }
                            ]
                        });

                        console.log('✅ DataTable initialized');
                    }

                    // Debug filters function
                    function debugFilters() {
                        console.log('🔍 DEBUGGING FILTERS...');

                        const formData = new FormData();

                        // Collect all filter data
                        document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                            formData.append(cb.name, cb.value);
                        });

                        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                            formData.append(radio.name, radio.value);
                        });

                        document.querySelectorAll('input[type="hidden"]').forEach(hidden => {
                            if (hidden.value) {
                                formData.append(hidden.name, hidden.value);
                            }
                        });

                        // Log all collected data
                        for (let [key, value] of formData.entries()) {
                            console.log(`${key}: ${value}`);
                        }

                        // Call debug endpoint
                        fetch('/DN/DebugFilters?' + new URLSearchParams(formData))
                            .then(response => response.json())
                            .then(data => {
                                console.log('📊 Debug response:', data);
                                alert('Debug completed! Check console for details.');
                            })
                            .catch(error => {
                                console.error('❌ Debug error:', error);
                                alert('Debug failed: ' + error.message);
                            });
                    }

                    // Export to Excel function
                    function exportToExcel(buttonElement) {
                        console.log('📊 Exporting to Excel...');

                        const form = document.querySelector('.filter-form');

                        if (!form) {
                            alert('❌ Không tìm thấy form filters. Vui lòng thử lại.');
                            return;
                        }

                        const formData = new FormData(form);

                        // Convert to URL parameters
                        const params = new URLSearchParams();

                        // Add all form data
                        for (let [key, value] of formData.entries()) {
                            params.append(key, value);
                        }

                        // Add hidden input values for limit options
                        const hiddenInputs = document.querySelectorAll('input[type="hidden"]');
                        hiddenInputs.forEach(input => {
                            if (input.value && input.name) {
                                params.append(input.name, input.value);
                            }
                        });

                        // Collect checkbox values (for multiple selections)
                        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                        checkboxes.forEach(checkbox => {
                            if (checkbox.name && checkbox.value) {
                                params.append(checkbox.name, checkbox.value);
                            }
                        });

                        // Collect radio button values
                        const radios = document.querySelectorAll('input[type="radio"]:checked');
                        radios.forEach(radio => {
                            if (radio.name && radio.value) {
                                params.append(radio.name, radio.value);
                            }
                        });

                        console.log('📊 Export parameters:', params.toString());

                        // Create download link
                        const exportUrl = '/DN/ExportToExcel?' + params.toString();

                        // Show loading message
                        const originalText = buttonElement.innerHTML;
                        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xuất...';
                        buttonElement.disabled = true;

                        // Use fetch to check for errors before downloading
                        fetch(exportUrl)
                            .then(response => {
                                // Check if response is JSON (error response)
                                const contentType = response.headers.get('content-type');
                                if (contentType && contentType.includes('application/json')) {
                                    // This is an error response, parse it
                                    return response.json().then(errorData => {
                                        throw new Error(errorData.message || 'Lỗi khi export dữ liệu');
                                    });
                                }
                                
                                // Check if response is OK for file download
                                if (response.ok) {
                                    // If response is OK, trigger download
                                    const link = document.createElement('a');
                                    link.href = exportUrl;
                                    link.style.display = 'none';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);

                                    // Show success message
                                    const alertDiv = document.createElement('div');
                                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                                    alertDiv.innerHTML = `
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>Thành công!</strong> File Excel đang được tải về.
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    `;

                                    // Insert alert before table container
                                    const tableContainer = document.querySelector('.table-container');
                                    if (tableContainer) {
                                        tableContainer.parentNode.insertBefore(alertDiv, tableContainer);

                                        // Auto remove alert after 5 seconds
                                        setTimeout(() => {
                                            if (alertDiv.parentNode) {
                                                alertDiv.remove();
                                            }
                                        }, 5000);
                                    }
                                } else {
                                    // Other HTTP errors
                                    throw new Error(`Lỗi HTTP: ${response.status} - ${response.statusText}`);
                                }
                            })
                            .catch(error => {
                                console.error('❌ Export error:', error);
                                
                                // Show error message with better formatting
                                const alertDiv = document.createElement('div');
                                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                                
                                // Determine specific error type and message
                                let errorTitle = '⚠️ Không thể xuất Excel!';
                                let errorMessage = '';
                                let errorIcon = 'fas fa-exclamation-triangle';
                                
                                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                                    // Network error
                                    errorTitle = '🌐 Lỗi kết nối mạng!';
                                    errorMessage = 'Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối internet và thử lại.';
                                    errorIcon = 'fas fa-wifi';
                                } else if (error.message.includes('ExportLimitExceeded')) {
                                    // Export limit exceeded
                                    errorTitle = '📊 Vượt quá giới hạn export!';
                                    errorMessage = error.message.replace('ExportLimitExceeded', '');
                                    errorIcon = 'fas fa-chart-line';
                                } else if (error.message.includes('Unauthorized')) {
                                    // Authentication error
                                    errorTitle = '🔐 Lỗi xác thực!';
                                    errorMessage = 'Vui lòng đăng nhập lại để export dữ liệu.';
                                    errorIcon = 'fas fa-user-lock';
                                } else if (error.message.includes('Lỗi HTTP: 500')) {
                                    // Server error
                                    errorTitle = '⚡ Lỗi máy chủ!';
                                    errorMessage = 'Máy chủ đang gặp sự cố. Vui lòng thử lại sau vài phút.';
                                    errorIcon = 'fas fa-server';
                                } else if (error.message.includes('Lỗi HTTP: 404')) {
                                    // Not found error
                                    errorTitle = '🔍 Không tìm thấy trang!';
                                    errorMessage = 'Trang export không tồn tại. Vui lòng liên hệ quản trị viên.';
                                    errorIcon = 'fas fa-search';
                                } else if (error.message.includes('Lỗi HTTP: 403')) {
                                    // Forbidden error
                                    errorTitle = '🚫 Không có quyền truy cập!';
                                    errorMessage = 'Bạn không có quyền export dữ liệu này.';
                                    errorIcon = 'fas fa-ban';
                                } else {
                                    // Generic error
                                    errorMessage = error.message;
                                }
                                
                                // Format specific error messages
                                if (errorMessage.includes('Tổng records export hôm nay')) {
                                    errorMessage = errorMessage.replace('Tổng records export hôm nay', '📊 Tổng records export hôm nay');
                                }
                                if (errorMessage.includes('vượt quá giới hạn cho role')) {
                                    errorMessage = errorMessage.replace('vượt quá giới hạn cho role', '❌ Vượt quá giới hạn cho role');
                                }
                                if (errorMessage.includes('số lần export')) {
                                    errorMessage = errorMessage.replace('số lần export', '🔄 Số lần export');
                                }
                                if (errorMessage.includes('records/ngày')) {
                                    errorMessage = errorMessage.replace('records/ngày', '📈 records/ngày');
                                }
                                
                                alertDiv.innerHTML = `
                                    <i class="${errorIcon} me-2"></i>
                                    <strong>${errorTitle}</strong><br>
                                    <span style="font-size: 0.9em; line-height: 1.4;">${errorMessage}</span>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                `;

                                // Insert alert before table container
                                const tableContainer = document.querySelector('.table-container');
                                if (tableContainer) {
                                    tableContainer.parentNode.insertBefore(alertDiv, tableContainer);

                                    // Auto remove alert after 15 seconds
                                    setTimeout(() => {
                                        if (alertDiv.parentNode) {
                                            alertDiv.remove();
                                        }
                                    }, 15000);
                                }
                            })
                            .finally(() => {
                                // Reset button
                                buttonElement.innerHTML = originalText;
                                buttonElement.disabled = false;
                            });
                    }

                    // Refresh table function
                    function refreshTable() {
                        window.location.reload();
                    }

                            // Show filter guide
        function showFilterGuide() {
            // Prevent multiple alerts
            if (window.guideAlertShown) {
                return;
            }
            window.guideAlertShown = true;
            
            const guide = `🎯 HƯỚNG DẪN SỬ DỤNG BỘ LỌC VIEWRAWDATA

📋 BỘ LỌC NAVIGATION:
   • Click nút "Bộ lọc" để mở/đóng
   • Multi-select: Giữ Ctrl + Click để chọn nhiều
   • Search: Gõ để tìm kiếm trong dropdown
   • Tự động lưu trạng thái mở/đóng

🔍 CÁC BỘ LỌC:
   • Năm: Chọn năm dữ liệu
   • Tỉnh/Thành phố: Lọc theo địa phương  
   • Loại hình KT: Lọc theo loại hình kinh tế
   • Vùng KT: Lọc theo vùng kinh tế
   • Kiểu xuất: Chọn cách xuất dữ liệu

📊 KIỂU XUẤT DỮ LIỆU:
   • Xuất Các Dòng Đầu: Nhập số lượng
   • Xuất Các Dòng Cuối: Nhập số lượng
   • Xuất Random: Nhập số lượng
   • Chọn Khoảng: Nhập STT từ X đến Y
   • Xuất Xen kẻ: Nhập khoảng và bước nhảy

⚡ TÍNH NĂNG:
   • Export Excel: Xuất dữ liệu đã lọc
   • Debug: Kiểm tra bộ lọc
   • DataTable: Tìm kiếm, sắp xếp, phân trang
   • Responsive: Tự động điều chỉnh trên mobile

💡 MẸO:
   • Dùng tìm kiếm trong dropdown để tìm nhanh
   • Có thể chọn nhiều mục trong cùng bộ lọc
   • Bộ lọc sẽ nhớ trạng thái khi điều hướng

📥 EXPORT EXCEL:
   • Click nút "Export Excel" để tải file
   • File sẽ chứa đúng dữ liệu đang hiển thị
   • Bao gồm tất cả cột và thông tin filter
   • Tên file có timestamp và thông tin bộ lọc`;
            
            alert(guide);
            
            // Reset flag after 2 seconds
            setTimeout(() => {
                window.guideAlertShown = false;
            }, 2000);
        }

        // Test Export Excel function
        function testExportExcel() {
            // Prevent multiple alerts
            if (window.testAlertShown) {
                return;
            }
            window.testAlertShown = true;
            
            console.log('🧪 TESTING EXPORT EXCEL FUNCTION...');
            
            // Check if form exists
            const form = document.querySelector('.filter-form');
            console.log('📋 Form found:', form ? 'Yes' : 'No');
            
            if (!form) {
                alert('❌ Form not found for export');
                window.testAlertShown = false;
                return;
            }
            
            // Collect all form data for testing
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            console.log('📊 Form elements found:');
            
            // Check form inputs
            const allInputs = form.querySelectorAll('input, select');
            console.log(`   - Total inputs: ${allInputs.length}`);
            
            // Check hidden inputs
            const hiddenInputs = document.querySelectorAll('input[type="hidden"]');
            console.log(`   - Hidden inputs: ${hiddenInputs.length}`);
            hiddenInputs.forEach(input => {
                if (input.value) {
                    console.log(`     - ${input.name}: ${input.value}`);
                    params.append(input.name, input.value);
                }
            });
            
            // Check checkboxes
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            console.log(`   - Checked checkboxes: ${checkboxes.length}`);
            checkboxes.forEach(checkbox => {
                console.log(`     - ${checkbox.name}: ${checkbox.value}`);
                params.append(checkbox.name, checkbox.value);
            });
            
            // Check radio buttons
            const radios = document.querySelectorAll('input[type="radio"]:checked');
            console.log(`   - Selected radios: ${radios.length}`);
            radios.forEach(radio => {
                console.log(`     - ${radio.name}: ${radio.value}`);
                params.append(radio.name, radio.value);
            });
            
            const exportUrl = '/DN/ExportToExcel?' + params.toString();
            console.log('🔗 Export URL:', exportUrl);
            
            alert(`✅ Export URL generated successfully!\n\nParameters found:\n- Hidden inputs: ${hiddenInputs.length}\n- Checkboxes: ${checkboxes.length}\n- Radio buttons: ${radios.length}\n\nCheck console for details.`);
            
            // Reset flag after 2 seconds
            setTimeout(() => {
                window.testAlertShown = false;
            }, 2000);
            
            return exportUrl;
        }
                </script>
            </body>

            </html>